# üê≥ Docker Deployment Guide - Finance Tracker

Complete guide for containerized deployment with Docker, Nginx load balancing, and horizontal scaling.

## üìã Table of Contents

- [Architecture Overview](#architecture-overview)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Environment Configuration](#environment-configuration)
- [Deployment](#deployment)
- [Scaling](#scaling)
- [Load Balancing](#load-balancing)
- [Monitoring & Health Checks](#monitoring--health-checks)
- [Security Best Practices](#security-best-practices)
- [Troubleshooting](#troubleshooting)

---

## üèóÔ∏è Architecture Overview

```
                     Internet
                        |
                        v
                   [Port 80]
                        |
                   [NGINX Proxy]
                   Load Balancer
                   Rate Limiting
                        |
        +---------------+---------------+
        |                               |
        v                               v
   [Backend API]                  [Frontend App]
   (2+ replicas)                  (2+ replicas)
   Express.js                     Next.js
   Port 5000                      Port 3000
        |                               |
        +---------------+---------------+
                        |
                        v
                 [PostgreSQL DB]
                 (Single instance)
                 Port 5432
```

### Components:

1. **Nginx Reverse Proxy** - Load balancer, rate limiter, SSL termination point
2. **Backend API** - Express.js with Prisma ORM (horizontally scalable)
3. **Frontend App** - Next.js with standalone output (horizontally scalable)
4. **PostgreSQL Database** - Primary data store with persistent volume

---

## üì¶ Prerequisites

- Docker Engine 20.10+
- Docker Compose 2.0+
- 2GB+ available RAM
- 10GB+ available disk space

### Installation:

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install docker.io docker-compose-plugin

# Verify installation
docker --version
docker compose version
```

---

## üöÄ Quick Start

### 1. Generate Environment Configuration

**IMPORTANT:** Never commit `.env` files with real secrets!

```bash
# Run the preparation script to generate secure secrets
./prep.sh
```

This script will:
- Generate a strong JWT secret (32 characters)
- Generate a secure database password (24 characters)
- Create `.env` file with proper permissions (600)
- Display configuration summary

### 2. Build and Start Services

```bash
# Build images and start all services
docker compose up -d --build

# View logs
docker compose logs -f

# Check service status
docker compose ps
```

### 3. Run Database Migrations

```bash
# Wait for database to be ready, then run migrations
docker compose exec backend npx prisma migrate deploy

# Optional: Generate Prisma client (if needed)
docker compose exec backend npx prisma generate
```

### 4. Access Application

- **Application URL:** http://localhost
- **API Base URL:** http://localhost/api
- **Nginx Health Check:** http://localhost/nginx-health

---

## ‚öôÔ∏è Environment Configuration

### `.env` File Structure

```bash
# Database Configuration
DB_USER=financeuser
DB_PASSWORD=<auto-generated-secure-password>
DB_NAME=financetracker

# JWT Secret
JWT_SECRET=<auto-generated-secure-secret>
```

### Manual Configuration (if not using prep.sh)

```bash
# Copy example file
cp .env.example .env

# Edit with your preferred editor
nano .env

# Generate secure random values:
# For JWT_SECRET:
openssl rand -base64 32 | tr -d "=+/" | cut -c1-32

# For DB_PASSWORD:
openssl rand -base64 24 | tr -d "=+/" | cut -c1-24
```

### Security Notes:

- ‚úÖ `.env` is in `.gitignore` - **never commit it!**
- ‚úÖ File permissions set to `600` (owner read/write only)
- ‚úÖ Secrets are isolated from `docker-compose.yml`
- ‚úÖ Use Docker secrets or vault in production

---

## üö¢ Deployment

### Development Deployment

```bash
# Start with default replicas (2 backend, 2 frontend)
docker compose up -d

# Watch logs in real-time
docker compose logs -f backend frontend
```

### Production Deployment

```bash
# Build optimized production images
docker compose build --no-cache

# Start in detached mode
docker compose up -d

# Verify health status
docker compose ps
```

### Service Management

```bash
# Stop all services
docker compose stop

# Stop specific service
docker compose stop backend

# Restart services
docker compose restart

# Remove containers (keeps volumes)
docker compose down

# Remove everything including volumes
docker compose down -v
```

---

## üìä Scaling

### Horizontal Scaling

Scale backend and frontend services independently:

```bash
# Scale backend to 4 instances
docker compose up -d --scale backend=4

# Scale frontend to 3 instances
docker compose up -d --scale frontend=3

# Scale both simultaneously
docker compose up -d --scale backend=5 --scale frontend=4
```

### View Scaled Instances

```bash
# List all running containers
docker compose ps

# Check resource usage
docker stats
```

### Scaling Strategies

**Backend Scaling:**
- Recommended: 2-4 instances for high availability
- Scale up during peak hours
- Each instance handles ~1000 req/min

**Frontend Scaling:**
- Recommended: 2-3 instances for high availability
- Primarily serves static assets
- Each instance handles ~2000 req/min

**When to Scale:**
- CPU usage > 70% consistently
- Response time > 200ms average
- High request rate (>100 req/s)
- Memory usage > 80%

---

## ‚öñÔ∏è Load Balancing

Nginx is configured with **least_conn** load balancing algorithm.

### Load Balancing Methods

Current: `least_conn` (routes to server with least active connections)

Alternatives in `nginx/nginx.conf`:

```nginx
# Round Robin (default)
upstream backend_api {
    server backend:5000;
}

# IP Hash (same client -> same server)
upstream backend_api {
    ip_hash;
    server backend:5000;
}

# Random with two choices
upstream backend_api {
    random two;
    server backend:5000;
}

# Weighted distribution
upstream backend_api {
    server backend:5000 weight=3;
    server backend:5000 weight=1;
}
```

### Health Checks

Nginx automatically removes unhealthy backends:
- `max_fails=3` - Mark server down after 3 failures
- `fail_timeout=30s` - Try again after 30 seconds

---

## üîç Monitoring & Health Checks

### Service Health Endpoints

```bash
# Nginx health
curl http://localhost/nginx-health

# Backend health (through nginx)
curl http://localhost/api/auth/health

# Frontend health
curl http://localhost/
```

### Docker Health Checks

All services include built-in health checks:

```bash
# View health status
docker compose ps

# Inspect specific service
docker inspect finance-tracker-nginx --format='{{.State.Health.Status}}'
```

### Viewing Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f backend

# Last 100 lines
docker compose logs --tail=100 backend

# Filter by timestamp
docker compose logs --since 30m backend
```

### Resource Monitoring

```bash
# Real-time resource usage
docker stats

# Specific containers
docker stats finance-tracker-nginx finance-tracker-db
```

---

## üîí Security Best Practices

### 1. Secrets Management

‚úÖ **DO:**
- Use `prep.sh` to generate random secrets
- Keep `.env` file permissions at `600`
- Use Docker secrets in production
- Rotate secrets regularly

‚ùå **DON'T:**
- Commit `.env` files to git
- Hardcode secrets in `docker-compose.yml`
- Share secrets via insecure channels
- Use default/weak passwords

### 2. Container Security

```yaml
# Non-root user execution (already configured)
USER nodejs  # in backend
USER nextjs  # in frontend

# Resource limits (already configured)
deploy:
  resources:
    limits:
      cpus: '0.5'
      memory: 512M
```

### 3. Network Security

- Services communicate via internal Docker network
- Only Nginx exposes port 80 externally
- Database is not directly accessible from outside

### 4. Rate Limiting

Configured in `nginx/nginx.conf`:
- API endpoints: 10 requests/second (burst 20)
- Frontend: 30 requests/second (burst 50)
- Connection limit: 10 per IP address

### 5. Security Headers

Automatically added by Nginx:
- `X-Frame-Options: SAMEORIGIN`
- `X-Content-Type-Options: nosniff`
- `X-XSS-Protection: 1; mode=block`
- `Referrer-Policy: no-referrer-when-downgrade`

### 6. Production Recommendations

```bash
# Use HTTPS (add SSL certificates to Nginx)
# Use Docker secrets instead of .env
# Enable audit logging
# Regular security updates
# Network segmentation
# Implement WAF (Web Application Firewall)
```

---

## üêõ Troubleshooting

### Container Won't Start

```bash
# Check logs
docker compose logs backend

# Check container status
docker compose ps

# Rebuild from scratch
docker compose down -v
docker compose up -d --build
```

### Database Connection Issues

```bash
# Verify database is healthy
docker compose ps postgres

# Check database logs
docker compose logs postgres

# Verify connection from backend
docker compose exec backend npx prisma db pull
```

### Port Conflicts

```bash
# If port 80 is in use, modify docker-compose.yml:
ports:
  - "8080:80"  # Use port 8080 instead

# Or stop conflicting service
sudo systemctl stop apache2  # Example
```

### Migration Errors

```bash
# Reset database (CAUTION: destroys data)
docker compose down -v
docker compose up -d postgres
sleep 10
docker compose up -d backend
docker compose exec backend npx prisma migrate deploy
```

### Performance Issues

```bash
# Check resource usage
docker stats

# Increase resources in docker-compose.yml
deploy:
  resources:
    limits:
      memory: 1G  # Increase from 512M

# Scale services
docker compose up -d --scale backend=4
```

### Nginx 502 Bad Gateway

```bash
# Backend might be down
docker compose ps backend

# Check backend logs
docker compose logs backend

# Restart backend
docker compose restart backend
```

---

## üìö Advanced Topics

### Custom Nginx Configuration

Edit `nginx/nginx.conf` and reload:

```bash
# Test configuration
docker compose exec nginx nginx -t

# Reload without downtime
docker compose exec nginx nginx -s reload
```

### Database Backup

```bash
# Backup
docker compose exec postgres pg_dump -U financeuser financetracker > backup.sql

# Restore
cat backup.sql | docker compose exec -T postgres psql -U financeuser financetracker
```

### Zero-Downtime Deployment

```bash
# Build new images
docker compose build

# Rolling update (requires swarm mode)
docker stack deploy -c docker-compose.yml finance-tracker
```

---

## üéØ Performance Optimization

### Image Size Optimization

Already implemented:
- Multi-stage builds
- Alpine Linux base images
- Minimal production dependencies

### Caching Strategy

```nginx
# Add to nginx.conf for static assets
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### Database Connection Pooling

Prisma automatically handles connection pooling. Adjust if needed in backend code:

```javascript
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
  pool: {
    min: 2,
    max: 10,
  },
});
```

---

## üìû Support

For issues or questions:
1. Check the logs: `docker compose logs -f`
2. Review this documentation
3. Check Docker and Docker Compose versions
4. Verify `.env` configuration

---

## üìù Changelog

- **v1.0.0** - Initial containerized setup
  - Multi-stage Dockerfiles
  - Nginx load balancing
  - Horizontal scaling support
  - Secure secrets management
  - Health checks & monitoring

---

**Happy Deploying! üöÄ**
